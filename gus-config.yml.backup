---
- name: Configure Gus (Control Machine)
  hosts: gus
  become: yes
  
  tasks:
    # Disable cloud-init
    - name: Disable cloud-init
      file:
        path: /etc/cloud/cloud-init.disabled
        state: touch
    
    - name: Stop cloud-init services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - cloud-config
        - cloud-final
        - cloud-init-local
        - cloud-init-main
        - cloud-init-network
        - cloud-init-hotplugd
      ignore_errors: yes
    
    # System basics
    - name: Update apt cache
      apt:
        update_cache: yes
    
    - name: Install packages for Gus (control machine)
      apt:
        name:
          - vim
          - htop
          - curl
          - git
          - ansible
          - python3-pip
        state: present
    
    - name: Set timezone to Hermosillo
      community.general.timezone:
        name: America/Hermosillo
    
    - name: Ensure hostname is gus
      hostname:
        name: gus
    
    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1       gus"
    
    # Make sure bobstephen has sudo without password
    - name: Ensure bobstephen can sudo without password
      lineinfile:
        path: /etc/sudoers.d/bobstephen-nopasswd
        line: "bobstephen ALL=(ALL) NOPASSWD: ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
    
    # SSH
    - name: Enable SSH
      systemd:
        name: ssh
        enabled: yes
        state: started
    
    # Tailscale - Interactive Login
    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
    
    - name: Download Tailscale GPG key
      get_url:
        url: https://pkgs.tailscale.com/stable/raspbian/bookworm.noarmor.gpg
        dest: /etc/apt/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'
    
    - name: Add Tailscale repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/raspbian bookworm main"
        state: present
        filename: tailscale
    
    - name: Install Tailscale
      apt:
        name: tailscale
        update_cache: yes
    
    - name: Check if Tailscale is already connected
      command: tailscale status
      register: ts_status
      changed_when: false
      failed_when: false
    
    - name: Display Tailscale setup instructions
      debug:
        msg:
          - "============================================"
          - "TAILSCALE SETUP"
          - "============================================"
          - "Tailscale is installed. To connect:"
          - "  sudo tailscale up --hostname=gus"
          - ""
          - "Then open the displayed URL in your browser"
          - "and authorize this device."
          - "============================================"
      when: ts_status.rc != 0
    
    # Webmin - Direct .deb install
    - name: Check if Webmin is already installed
      command: dpkg -l webmin
      register: webmin_check
      changed_when: false
      failed_when: false
    
    - name: Download Webmin .deb package
      get_url:
        url: https://www.webmin.com/download/deb/webmin-current.deb
        dest: /tmp/webmin-current.deb
        mode: '0644'
      when: webmin_check.rc != 0
    
    - name: Install Webmin from .deb
      apt:
        deb: /tmp/webmin-current.deb
        state: present
      when: webmin_check.rc != 0
    
    - name: Fix any dependency issues
      apt:
        name: webmin
        state: fixed
      when: webmin_check.rc != 0
    
    - name: Ensure Webmin is started and enabled
      systemd:
        name: webmin
        enabled: yes
        state: started
    
    # Optimize Webmin for Tailscale access (fixes CPU usage issue)
    - name: Configure Webmin for Tailscale (fix CPU issue)
      lineinfile:
        path: /etc/webmin/miniserv.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^ssl=', line: 'ssl=0' }
        - { regexp: '^cookie_path=', line: 'cookie_path=/' }
        - { regexp: '^sessiononly=', line: 'sessiononly=1' }
        - { regexp: '^trust=', line: 'trust=100.64.0.0/10' }
        - { regexp: '^logouttime=', line: 'logouttime=10' }
        - { regexp: '^no_session_clear=', line: 'no_session_clear=1' }
      notify: restart webmin
    
    # Cron jobs
    - name: Daily updates at 2:05 AM
      cron:
        name: "Daily system updates"
        minute: "5"
        hour: "2"
        job: "/usr/bin/apt update && /usr/bin/apt upgrade -y && /usr/bin/apt autoremove -y"
        user: root
    
    - name: Daily reboot at 3:05 AM
      cron:
        name: "Daily reboot"
        minute: "5"
        hour: "3"
        job: "/sbin/reboot"
        user: root
    
    - name: Display completion message
      debug:
        msg:
          - "===================================="
          - "Gus configuration complete!"
          - "===================================="
          - "Timezone: America/Hermosillo"
          - "User: bobstephen"
          - "cloud-init: DISABLED ✓"
          - "Tailscale: INSTALLED ✓"
          - "Webmin: INSTALLED ✓"
          - "Webmin Tailscale optimized ✓"
          - "  - SSL disabled (Tailscale encrypts)"
          - "  - CPU fix applied"
          - "Cron jobs: CONFIGURED ✓"
          - ""
          - "Cron Schedule:"
          - "- 2:05 AM: System updates"
          - "- 3:05 AM: Daily reboot"
          - ""
          - "Access Webmin at:"
          - "  http://192.168.25.53:10000"
          - "  http://100.103.213.74:10000 (Tailscale)"
          - "===================================="
  
  handlers:
    - name: restart webmin
      systemd:
        name: webmin
        state: restarted
